{{- if and (hasKey $.Values.mariadb "autostart") (not $.Values.mariadb.autostart) }}
{{- else if and ($.Values.command) (hasKey $.Values.command "application") }}
{{- else if and (hasKey $.Values.mariadb.galera.restore "restic") (not $.Values.mariadb.galera.restore.restic.enabled) }}
{{- else }}
apiVersion: batch/v1
kind: Job
metadata:
  namespace: {{ $.Release.Namespace }}
  name: {{ include "commonPrefix" $ }}restore-restic-{{ randAlphaNum 8 | lower }}
  labels:
    app: {{ $.Release.Name }}
    release: {{ $.Release.Name }}
    backupsoftware: restic
spec:
  backoffLimit: {{ $.Values.job.resticrestore.backoffLimit | default 0 | int }}
  activeDeadlineSeconds: {{ $.Values.job.resticrestore.activeDeadlineSeconds | default 3600 | int }}
  ttlSecondsAfterFinished: {{ $.Values.job.resticrestore.ttlSecondsAfterFinished | default 43200 | int }}
  template:
    metadata:
      labels:
        app: {{ $.Release.Name }}
        release: {{ $.Release.Name }}
      annotations:
        checksum/configmap: {{ include (print $.Template.BasePath "/configmap-restic.yaml") $ | sha256sum }}
    spec:
      restartPolicy: {{ $.Values.job.resticrestore.jobRestartPolicy | default "Never" | quote }}
      serviceAccount: {{ include "commonPrefix" $ }}{{ $.Release.Name }}
      securityContext:
        runAsUser:  {{ $.Values.userId.backup | default 3200 | int }}
        runAsGroup: {{ $.Values.groupId.backup | default 3200 | int }}
        fsGroup:  {{ $.Values.groupId.backup | default 3200 | int }}
      imagePullSecrets:
      - name: {{ include "commonPrefix" $ }}{{ $.Release.Name }}-{{$.Values.image.application.pullSecret}}
      containers:
      - name: restore
        image: "{{ $.Values.image.resticbackup.registry }}/{{ $.Values.image.resticbackup.project }}/{{ $.Values.image.resticbackup.applicationname }}:{{ $.Values.image.resticbackup.applicationversion }}-{{ $.Values.image.resticbackup.imageversion }}"
        imagePullPolicy: {{ $.Values.image.resticbackup.pullPolicy | default "IfNotPresent" | quote }}
        securityContext:
          runAsUser:  {{ $.Values.userId.backup | default 3200 | int }}
          runAsGroup: {{ $.Values.groupId.backup | default 3200 | int }}
        {{- if and ($.Values.command) (hasKey $.Values.command "jobrestore") }}
        command:
{{ $.Values.command.jobrestore | toYaml | indent 8 }}
        {{- end }}
        env:
        {{- if and (hasKey $.Values.mariadb.galera.backup.restic "backend") (eq $.Values.mariadb.galera.backup.restic.backend "openstackswift") }}
        - name: OS_AUTH_URL
          value: {{ required "Values.mariadb.galera.backup.restic.openstack.authurl is missing, but required for the Openstack Swift authentication." $.Values.mariadb.galera.backup.restic.openstack.authurl }}
        - name: OS_IDENTITY_API_VERSION
          value: "3"
        - name: OS_REGION_NAME
          value: {{ required "Values.mariadb.galera.backup.restic.openstack.region is missing, but required for the Openstack Swift authentication." $.Values.mariadb.galera.backup.restic.openstack.region }}
        - name: OS_PROJECT_NAME
          value: {{ required "Values.mariadb.galera.backup.restic.openstack.projectname is missing, but required for the Openstack Swift authentication." $.Values.mariadb.galera.backup.restic.openstack.projectname }}
        - name: OS_PROJECT_DOMAIN_NAME
          value: {{ required "Values.mariadb.galera.backup.restic.openstack.tenantname is missing, but required for the Openstack Swift authentication." $.Values.mariadb.galera.backup.restic.openstack.tenantname }}
        - name: OS_USER_DOMAIN_NAME
          value: {{ required "Values.mariadb.galera.backup.restic.openstack.tenantname is missing, but required for the Openstack Swift authentication." $.Values.mariadb.galera.backup.restic.openstack.tenantname }}
        {{- end }}
        - name: RESTIC_REPOSITORY
          value: {{ (printf "swift:%s:/" (required "Values.mariadb.galera.backup.restic.openstack.container is missing, but required for restic to access the repository." $.Values.mariadb.galera.backup.restic.openstack.container)) | quote }}
        - name: RESTIC_PROGRESS_FPS
          value: {{ $.Values.mariadb.galera.backup.restic.progressFps | default "0.01666" | quote }}
        - name: TMPDIR
          value: "/opt/${SOFTWARE_NAME}/var/tmp/"
        - name: MARIADB_VERSION
          value: {{ (required ".image.application.applicationversion" $.Values.image.application.applicationversion) | quote }}
        - name: MYSQL_PORT
          value: {{ (required ".services.application.frontend.ports.mysql.targetPort missing" $.Values.services.application.frontend.ports.mysql.targetPort) | quote }}
        - name: DB_HOST
          value: "{{ (include "nodeNamePrefix" (dict "global" $ "component" "application")) }}-0.database.svc.cluster.local"
        - name: RESTORE_TIMESTAMP
          value: {{ $.Values.mariadb.galera.restore.beforeTimestamp | default "false" | quote }}
        - name: RESTORE_SNAPSHOT_ID
          value: {{ $.Values.mariadb.galera.restore.restic.snapshotId | default "false" | quote }}
        {{- range $envKey, $envValue := $.Values.env }}
          {{- if (has "jobrestore-restic" $envValue.containerType) }}
        - name: {{ $envKey }}
            {{- if $envValue.value }}
          value: {{ $envValue.value | quote }}
            {{- end }}
            {{- if $envValue.secretName }}
          valueFrom:
            secretKeyRef:
              name: {{ include "commonPrefix" $ }}{{ $.Release.Name }}-{{ $envValue.secretName }}
              key: {{ $envValue.secretKey }}
            {{- end }}
          {{- end }}
        {{- end }}
        resources:
          requests:
            cpu: {{ $.Values.resourceLimits.cpu.jobrestore | default 0.5 }}
          limits:
            memory: {{ $.Values.resourceLimits.memory.jobrestore | default "128Mi" | quote }}
        volumeMounts:
        - name: {{ include "commonPrefix" $ }}restic-entrypoint-sh
          mountPath: /opt/restic/bin/entrypoint.sh
          subPath: entrypoint-restore.sh
          readOnly: true
        - name: {{ include "commonPrefix" $ }}restic-common-functions-extended-sh
          mountPath: /opt/restic/bin/common-functions-extended.sh
          subPath: common-functions-extended.sh
          readOnly: true
      volumes:
      {{- range $volumeMountsKey, $volumeMountsValue := $.Values.volumeMounts.application }}
        {{- if $volumeMountsValue.type }}
          {{- if ne $volumeMountsValue.type "persistentVolume" }}
      - name: {{ include "commonPrefix" $ }}{{ $volumeMountsKey }}
            {{- if eq $volumeMountsValue.type "secret"}}
        {{ $volumeMountsValue.type }}:
          secretName: {{ include "commonPrefix" $ }}{{ $.Release.Name }}-{{ $volumeMountsKey }}
            {{- else if eq $volumeMountsValue.type "hostPath" }}
        {{ $volumeMountsValue.type }}:
          path: {{ $volumeMountsValue.hostPath }}
            {{- else }}
          name: {{ include "commonPrefix" $ }}{{ $volumeMountsKey }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      - name: {{ include "commonPrefix" $ }}restic-entrypoint-sh
        configMap:
          name: {{ include "commonPrefix" $ }}restic-entrypoint-sh
          defaultMode: 0750
      - name: {{ include "commonPrefix" $ }}restic-common-functions-extended-sh
        configMap:
          name: {{ include "commonPrefix" $ }}restic-common-functions-extended-sh
          defaultMode: 0755
{{- end }}